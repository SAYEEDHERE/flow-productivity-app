<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Flow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: rgb(17 24 39); color: rgb(229 231 235); overflow-x: hidden; }
        .font-poppins { font-family: 'Poppins', sans-serif; }
        .glass-effect { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        @keyframes blob { 0% { transform: translate(0px, 0px) scale(1); } 33% { transform: translate(30px, -50px) scale(1.1); } 66% { transform: translate(-20px, 20px) scale(0.9); } 100% { transform: translate(0px, 0px) scale(1); } }
        .animation-delay-2000 { animation-delay: 2s; }
        .animation-delay-4000 { animation-delay: 4s; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1.25rem; border-radius: 0.5rem; color: #d1d5db; transition: all 0.2s ease-in-out; font-weight: 500;}
        .sidebar-link:hover { background-color: rgba(255, 255, 255, 0.1); color: #f9fafb; }
        .sidebar-link.active { background-color: #4f46e5; color: #f9fafb; }
        .sidebar-link i { width: 1.25rem; margin-right: 0.75rem; text-align: center; }
    </style>
</head>
<body class="antialiased">

    <div class="relative min-h-screen w-full">
        <!-- Animated Background Shapes -->
        <div class="absolute top-0 -left-4 w-72 h-72 bg-purple-500 rounded-full mix-blend-screen filter blur-xl opacity-30 animate-blob"></div>
        <div class="absolute top-0 -right-4 w-72 h-72 bg-yellow-500 rounded-full mix-blend-screen filter blur-xl opacity-30 animate-blob animation-delay-2000"></div>
        <div class="absolute -bottom-8 left-20 w-72 h-72 bg-pink-500 rounded-full mix-blend-screen filter blur-xl opacity-30 animate-blob animation-delay-4000"></div>

        <!-- App Layout -->
        <div class="relative min-h-screen flex z-10">
            <!-- Sidebar -->
            <aside class="w-64 glass-effect p-6 flex-shrink-0 flex flex-col justify-between">
                <div>
                    <div class="flex items-center gap-3 px-2 mb-10"><i class="fas fa-wave-square text-2xl text-indigo-400"></i><h1 class="text-2xl font-bold font-poppins text-white">Flow</h1></div>
                    <nav class="space-y-2">
                        <a href="#" class="sidebar-link active"><i class="fas fa-home"></i><span>Home</span></a>
                        <a href="goals.html" class="sidebar-link"><i class="fas fa-bullseye"></i><span>Goals</span></a>
                        <a href="tasks.html" class="sidebar-link"><i class="fas fa-check-circle"></i><span>Tasks</span></a>
                        <a href="pomodoro.html" class="sidebar-link"><i class="fas fa-clock"></i><span>Pomodoro</span></a>
                        <a href="mood-tracker.html" class="sidebar-link"><i class="fas fa-smile-beam"></i><span>Mood Tracker</span></a>
                        <a href="analytics.html" class="sidebar-link"><i class="fas fa-chart-pie"></i><span>Analytics</span></a>
                    </nav>
                </div>
                <div><a href="settings.html" class="sidebar-link"><i class="fas fa-cog"></i><span>Settings</span></a></div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-8 overflow-y-auto">
                <header class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                        <div>
                            <h2 class="text-3xl font-bold text-white font-poppins">Welcome Back, <span id="user-name"></span></h2>
                            <p id="quote-of-the-day" class="text-gray-400">Loading an inspiring quote...</p>
                        </div>
                        <button id="info-btn" class="text-gray-500 hover:text-white transition"><i class="fas fa-info-circle text-2xl"></i></button>
                    </div>
                    <button id="logout-button" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition">Sign Out</button>
                </header>
                
                <div id="loading-spinner" class="text-center p-8 text-gray-400"><i class="fas fa-spinner fa-spin text-3xl"></i><p class="mt-4">Loading your dashboard...</p></div>

                <div id="dashboard-content" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="glass-effect p-6 rounded-xl"><p class="text-gray-400 text-sm">Active Tasks</p><p id="active-tasks" class="text-3xl font-bold text-white">--</p></div>
                        <div class="glass-effect p-6 rounded-xl"><p class="text-gray-400 text-sm">Goals in Progress</p><p id="goals-in-progress" class="text-3xl font-bold text-white">--</p></div>
                        <div class="glass-effect p-6 rounded-xl"><p class="text-gray-400 text-sm">Minutes Focused Today</p><p id="minutes-today" class="text-3xl font-bold text-white">--</p></div>
                        <div class="glass-effect p-6 rounded-xl"><p class="text-gray-400 text-sm">Current Streak</p><p id="current-streak" class="text-3xl font-bold text-white">-- ðŸ”¥</p></div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 glass-effect rounded-xl p-8">
                            <h3 class="text-xl font-bold text-white mb-4">Today's Focus</h3>
                            <ul id="todays-focus-list" class="space-y-4"></ul>
                        </div>
                        <div class="glass-effect rounded-xl p-8 flex flex-col items-center justify-center text-center">
                            <div class="flex items-center justify-center h-20 w-20 rounded-full bg-indigo-500/20 mx-auto mb-4"><i class="fas fa-clock text-4xl text-indigo-400"></i></div>
                            <h3 class="text-xl font-bold text-white">Ready to focus?</h3>
                            <p class="text-gray-400 mt-2 mb-6">Jump right into a productive session.</p>
                            <a href="pomodoro.html" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition">Start Pomodoro</a>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="info-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass-effect rounded-xl p-8 max-w-2xl w-full mx-4 relative prose prose-invert prose-headings:font-poppins prose-headings:text-white prose-p:text-gray-300">
            <button id="close-info-btn" class="absolute top-4 right-4 text-gray-500 hover:text-white transition"><i class="fas fa-times text-2xl"></i></button>
            
            <h2 class="text-center">Welcome to Flow: A New Way to Achieve</h2>
            <p>You have big dreams and ambitious goals. But the gap between your vision and your daily actions can feel vast. Flow is designed to bridge that gap, transforming your ambitions into a clear, actionable system for success.</p>
            
            <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
                <div>
                    <h4 class="font-bold text-white"><i class="fas fa-bullseye text-indigo-400 mr-2"></i>Clarity Through Goals</h4>
                    <p class="text-sm">Deconstruct your biggest ambitions into manageable, long-term goals. This isn't just a wish list; it's the strategic roadmap for your life.</p>
                </div>
                <div>
                    <h4 class="font-bold text-white"><i class="fas fa-check-circle text-indigo-400 mr-2"></i>Action Through Tasks</h4>
                    <p class="text-sm">Link actionable, daily tasks directly to your goals. Every task you complete is a concrete step forward, building momentum and turning your abstract goals into tangible progress.</p>
                </div>
                <div>
                    <h4 class="font-bold text-white"><i class="fas fa-brain text-indigo-400 mr-2"></i>Focus Through Pomodoro</h4>
                    <p class="text-sm">True progress happens during periods of deep, uninterrupted focus. Our integrated Pomodoro timer is your tool to eliminate distractions and dedicate real time to what truly matters.</p>
                </div>
                 <div>
                    <h4 class="font-bold text-white"><i class="fas fa-smile-beam text-indigo-400 mr-2"></i>Awareness Through Mood</h4>
                    <p class="text-sm">Productivity isn't just about what you do; it's about how you feel. By tracking your mood, you'll discover the patterns between your well-being and your performance, unlocking a new level of self-awareness.</p>
                </div>
            </div>

            <p class="text-center mt-8 font-semibold">This isn't just another to-do list. This is your system for a focused, intentional, and successful life. Welcome to the state of Flow.</p>
        </div>
    </div>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDvOSwEPDT1kiBFEdUXyH_3-ZlLLaUPmmk",
          authDomain: "flow-ea773.firebaseapp.com",
          projectId: "flow-ea773",
          storageBucket: "flow-ea773.appspot.com",
          messagingSenderId: "426640040797",
          appId: "1:426640040797:web:1ffcd2becbf8d33b097eb4"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-name').textContent = user.email.split('@')[0];
                fetchDashboardData();
                displayQuoteOfTheDay();
            } else {
                window.location.href = window.location.href.replace('dashboard.html', 'auth.html');
            }
        });
        
        const fetchDashboardData = async () => {
             if (!currentUser) return;
            try {
                const [tasksDocs, goalsDocs, analyticsDocs] = await Promise.all([
                    getDocs(collection(db, 'users', currentUser.uid, 'tasks')).then(snap => snap.docs.map(d => d.data())),
                    getDocs(collection(db, 'users', currentUser.uid, 'goals')).then(snap => snap.docs.map(d => d.data())),
                    getDocs(collection(db, 'users', currentUser.uid, 'analytics')).then(snap => snap.docs.map(d => ({ id: d.id, ...d.data() })))
                ]);

                // --- Calculate Stats ---
                const activeTasks = tasksDocs.filter(t => !t.completed).length;
                const goalsInProgress = goalsDocs.length;
                
                const todayStr = new Date().toISOString().slice(0, 10);
                const todaysAnalytics = analyticsDocs.find(d => d.id === todayStr);
                const minutesToday = todaysAnalytics?.minutesFocused || 0;

                let streak = 0;
                const focusDays = new Set(analyticsDocs.filter(d => d.minutesFocused > 0).map(d => d.id));
                let checkDate = new Date();
                while(focusDays.has(checkDate.toISOString().slice(0, 10))) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                }
                
                // --- Find Today's Focus Tasks ---
                const todaysTasks = tasksDocs
                    .filter(t => !t.completed && t.dueDate === todayStr)
                    .sort((a, b) => {
                        const priorityOrder = { 'High': 3, 'Medium': 2, 'Low': 1 };
                        return (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0);
                    })
                    .slice(0, 3);

                // --- Render UI ---
                updateStatCards({ activeTasks, goalsInProgress, minutesToday, streak });
                renderTodaysFocus(todaysTasks);

                document.getElementById('loading-spinner').style.display = 'none';
                document.getElementById('dashboard-content').classList.remove('hidden');

            } catch (error) {
                console.error("Error fetching dashboard data:", error);
                document.getElementById('loading-spinner').innerHTML = '<p class="text-red-500">Could not load dashboard data.</p>';
            }
        };

        const updateStatCards = (stats) => {
            document.getElementById('active-tasks').textContent = stats.activeTasks;
            document.getElementById('goals-in-progress').textContent = stats.goalsInProgress;
            document.getElementById('minutes-today').textContent = `${stats.minutesToday} min`;
            document.getElementById('current-streak').textContent = `${stats.streak} Days ðŸ”¥`;
        };

        const renderTodaysFocus = (tasks) => {
            const listEl = document.getElementById('todays-focus-list');
            listEl.innerHTML = '';
            if (tasks.length === 0) {
                listEl.innerHTML = `<li class="text-center text-gray-500 p-4">No tasks due today. Plan your day or enjoy the quiet!</li>`;
                return;
            }
            const priorityStyles = { 'High': 'border-l-red-500', 'Medium': 'border-l-yellow-500', 'Low': 'border-l-sky-500' };
            tasks.forEach(task => {
                const li = document.createElement('li');
                li.className = `bg-gray-900/50 p-4 rounded-lg border-l-4 ${priorityStyles[task.priority] || 'border-l-gray-500'}`;
                li.innerHTML = `<p class="font-semibold text-white">${task.title}</p>${task.goalTitle ? `<p class="text-xs text-indigo-400 mt-1">${task.goalTitle}</p>` : ''}`;
                listEl.appendChild(li);
            });
        };

        const displayQuoteOfTheDay = () => {
            const quotes = [
                "The secret of getting ahead is getting started.",
                "The only way to do great work is to love what you do.",
                "Donâ€™t watch the clock; do what it does. Keep going.",
                "Success is not final, failure is not fatal: it is the courage to continue that counts.",
                "Believe you can and you're halfway there."
            ];
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            document.getElementById('quote-of-the-day').textContent = quotes[dayOfYear % quotes.length];
        };

        document.getElementById('logout-button').addEventListener('click', () => {
            signOut(auth);
        });

        const infoBtn = document.getElementById('info-btn');
        const infoModal = document.getElementById('info-modal');
        const closeInfoBtn = document.getElementById('close-info-btn');

        infoBtn.addEventListener('click', () => {
            infoModal.classList.remove('hidden');
        });

        closeInfoBtn.addEventListener('click', () => {
            infoModal.classList.add('hidden');
        });

    </script>
</body>
</html>